# Streams

redis:5 supports stream, which is a storage structure in the log form in which you can append data.

Usecases:
- message queues
- time series storage

Compare with go-nats?


# Usage

## Adding elements to stream

Add key-value pairs of stream elements.
```bash
redis > XADD stream$ * name john age 10
1531989605376-0
```

- `XADD`: command to add key-value pairs
- `stream$`: the name of the stream, $ represents stream
- `*`: the element id, `*` indicates that an element id is generated by the system automatically
- we add two key value pairs, in json it would look like this `{"name": "john", "age": 20}`

The output will be the id of the newly added element, consisting of a timestamp and an incrementing number.

```
# Returns the number of elements in the stream.
XLEN stream$ 

# Query the elements in the stream by start and end id, or - to + indicates the smallest id to the largest id. We can limit the number of items returned with COUNT syntax
XRANGE stream$ - + COUNT 2

# Similar as above, but returned in the reverse order.
XREVRANGE stream$ - +

# Listens to a new elements of stream. 0 is the smallest id
XREAD COUNT 2 STREAMS stream$ 0

# Blocking listener
## Reads. 0 means no timeout. $ is the maximum id in the stream.
redis1 > XREAD BLOCK 0 STREAMS stream$ $
## Writes.
redis2 > XADD stream$ * test 1
```

## Consumer Group

Allows multiple consumers to process the same stream to implement load balancing.

```bash
# Create a consumer group for stream$, with the group name mygrup01. $ means read the element that is after the current maximum id.
XGROUP CREATE stream$ mygroup01 $

# Seed test data.
XADD mystream * message apple 
XADD mystream * message banana

# Reading data through the consumer group.
# - mygroup01: is the group name
# - Alice: the name of the group member (consumer)
# - >: means the data has not been read by the member of the consumers so far.
XREADGROUP GROUP mygroup01 Alice COUNT 1 STREAMS mystream >


# Consumption confirmation
XADD mystream mygroup01 1531999977149-0

# After consumption, the message will be soft deleted.
XREADGROUP GROUP mygroup01 Alice STREAMS mystream 0
```


## Failure processing

If the consumers are problematic, their messages is still tied to them and we cannot recover them. The solution is to change the owner of the data.

```
# List all the unprocessed data.
XPENDING mystream mygroup01 - + 10

# Change the owner of the unprocessed data.
# - Transfer ownership to Gates
# - 3600 refers to the idle time
XCLAIM mystream mygroup01 Gates 3600 1531999980272-0 1531999983493-0
```
